from dotenv import load_dotenv
import os
import pandas as pd
import asyncio
import re
import pickle
import ftfy
from nltk.corpus import stopwords
from nltk.stem import WordNetLemmatizer
from nltk.tokenize import word_tokenize
from src.data_receiver.telegram_receiver import TelegramFetcher


async def get_and_process_telegram_reports(target_date, db_handler):
    load_dotenv()
    telegram_api_id = os.environ.get("TELEGRAM_API_ID")
    telegram_api_hash = os.environ.get("TELEGRAM_API_HASH")
    session = 'anon_session'
    output = 'data/telegram_data'
    target = '@war_monitor'

    script_dir = os.path.dirname(os.path.abspath(__file__))
    project_root = os.path.abspath(os.path.join(script_dir, '..', '..')) 
    output_dir_abs = os.path.join(project_root, 'data', 'telegram_data')
    artifacts_dir = os.path.join(project_root, 'artifacts')

    fetcher = TelegramFetcher(telegram_api_id, telegram_api_hash, session, output_dir_abs)

    messages = await fetcher.fetch_messages(
        chat_id=target,
        start_date=target_date,
        end_date=target_date
    )

    timestamp = target_date.strftime("%Y%m%d")
    fname = f"tg_messages_{timestamp}.csv"
    await fetcher.save_messages_to_csv(messages, fname)
    await fetcher.disconnect()

    csv_filepath_abs = os.path.join(output_dir_abs, fname)
    df = pd.read_csv(csv_filepath_abs)

    df = df.dropna()
    df['date'] = pd.to_datetime(df['date'], utc=True, format='mixed', errors='coerce')
    df['date'] = df['date'].dt.tz_convert('Europe/Kyiv')
    df['date'] = df['date'].dt.tz_localize(None)
    df['date'] = df['date'].dt.date.astype(str)

    df = df.groupby('date').agg({
        'message': lambda x: '\n'.join(x),
    }).reset_index()

    db_handler.insert_telegram_report(df)
    df = db_handler.get_telegram_reports(daily_fetcher=True)

    lemmatizer = WordNetLemmatizer()

    stop_words = set(stopwords.words('russian'))

    custom_stops = {
        # --- Metadata / Reporting / Channel Specific ---
        "повідомлення", "сообщение", "повідомляють", "сообщают", "інформація", "информация", "офіційно", "официально",
        "неофіційно", "неофициально", "підтверджено", "подтверждено", "непідтверджено", "неподтверждено", "оновлення",
        "обновление",
        "доповнення", "дополнение", "дані", "данные", "станом", "состоянию", "джерело", "источник", "згідно",
        "согласно",
        "як", "как", "без",
        "канал", "channel", "телеграм", "телеграмм", "telegram", "пост", "post", "публікація", "публикация",
        "репост", "пересилка", "forwarded", "fwd", "увага", "внимание", "важливо", "важно", "терміново", "срочно",
        "екстрено", "экстренно", "звіт", "отчет", "огляд", "обзор", "ситуація", "ситуация", "карта", "карты",
        "актуальна", "актуальная", "інтерактивна", "интерактивная", "карта", "карті", "карте",
        "попередньо", "предварительно", "уточнюється", "уточняется", "деталі", "детали", "подробиці", "подробности",
        "відомо", "известно", "пишуть", "пишут", "кажуть", "говорят", "заявили", "заявил", "заявила", "заявило",
        "коментар", "комментарий", "цитата", "заява", "заявление", "інтерв'ю", "интервью", "брифінг", "брифинг",
        "підсумок", "итог", "підсумки", "итоги", "аналіз", "анализ", "оцінка", "оценка", "факт", "від", "от",
        "фактчекінг", "фактчекинг", "спростування", "опровержение", "реакція", "реакция", "читати", "читать",
        "дивитись", "смотреть",
        "далі", "далее", "тут", "здесь", "нижче", "ниже", "вище", "выше", "посилання", "ссылка", "лінк", "линк",
        "продовження", "продолжение", "початок", "начало", "кінець", "конец", "частина", "часть", "номер", "№", "no",
        "фото", "відео", "аудіо", "photo", "video", "audio", "скріншот", "скриншот", "screenshot", "UPD", "upd",
        "станом", "обстановка",

        # --- Generic Time References ---
        "година", "годин", "год", "час", "часов", "хвилина", "хвилин", "хв", "минута", "минут", "мин",
        "секунда", "секунд", "сек",
        "день", "дня", "днів", "день", "дня", "дней",
        "ніч", "ночі", "ночей", "ночь", "ночи", "ночей",
        "ранок", "ранку", "утро", "утра", "вечір", "вечора", "вечер", "вечера",
        "сьогодні", "сегодня", "вчора", "вчера", "завтра",
        "нещодавно", "недавно", "зранку", "утром", "вдень", "днем",
        "ввечері", "вечером", "вночі", "ночью", "дата",
        "місяць", "месяц", "рік", "год", "тиждень", "неделя",
        "минулий", "прошлый", "наступний", "следующий", "поточний", "текущий", "зараз", "сейчас", "тепер", "теперь",
        "потім", "потом", "доба", "сутки", "годинник", "часы", "календар", "календарь",
        "понеділок", "вівторок", "середа", "четвер", "п'ятниця", "субота", "неділя",
        "понедельник", "вторник", "среда", "четверг", "пятница", "суббота", "воскресенье",
        "січень", "лютий", "березень", "квітень", "травень", "червень", "липень", "серпень", "вересень", "жовтень",
        "листопад", "грудень",
        "январь", "февраль", "март", "апрель", "май", "июнь", "июль", "август", "сентябрь", "октябрь", "ноябрь",
        "декабрь",
        "близько", "около", "приблизно", "приблизительно", "орієнтовно", "ориентировочно", "біля", "около",
        "РФ", "назад", "тому",

        # --- Generic Verbs ---
        "бути", "быть", "мати", "иметь", "робити", "делать", "зробити", "сделать", "могти", "мочь", "вміти", "уметь",
        "сказати", "сказать", "говорити", "говорить", "повідомляти", "сообщать", "повідомити", "сообщить",
        "тривати", "продолжаться", "продовжувати", "продолжать", "починати", "начинать", "почати", "начать",
        "закінчувати", "заканчивать", "закінчити", "закончить", "знаходитись", "находиться", "перебувати", "пребывать",
        "відбуватись", "происходить", "стати", "стать", "чути", "слышать", "давати", "давать", "дати", "дать", "брати",
        "брать", "взяти", "взять", "отримувати", "получать",
        "отримати", "получить", "використовувати", "использовать", "застосовувати", "применять", "здійснювати",
        "осуществлять",
        "працювати", "работать", "діяти", "действовать", "залишатись", "оставаться", "залишити", "оставить",
        "очікувати", "ожидать", "очікується", "ожидается", "рухатись", "двигаться", "йти", "идти", "їхати", "ехать",
        "летіти", "лететь", "прибувати", "прибывать", "виглядати", "выглядеть", "намагатись", "пытаться", "пробувати",
        "пробовать",
        "вважати", "считать", "називати", "называть", "заявляти", "заявлять", "фіксувати", "фиксировать",
        "спостерігати", "наблюдать", "означати", "означать", "значити", "значить",
        "підтверджувати", "подтверждать", "спростовувати", "опровергать", "зберігати", "сохранять", "захищати",
        "защищать",
        "атакувати", "атаковать", "вести", "включати", "включать", "містити", "содержать",

        # --- Generic Nouns ---
        "район", "область", "місто", "село", "населений", "пункт",
        "територія", "территория", "регіон", "регион", "країна", "страна", "місце", "место", "зона", "зона",
        "напрямок", "направление", "бік", "сторона", "частина", "часть", "ділянка", "участок", "сектор", "сектор",
        "тип", "тип", "вид", "вид", "різновид", "разновидность", "рівень", "уровень", "ступінь", "степень",
        "кількість", "количество", "номер", "номер", "число", "число", "група", "группа", "особа", "лицо", "люди",
        "люди",
        "населення", "население", "мешканці", "жители", "громада",
        "засіб", "средство", "об'єкт", "объект", "предмет", "предмет", "питання", "вопрос", "тема", "тема",
        "причина", "причина", "наслідок", "последствие", "результат", "результат", "вихід", "выход", "вхід", "вход",
        "шлях", "путь", "дорога", "дорога", "мета", "цель", "завдання", "задача", "план", "план",
        "дія", "действие", "подія", "событие", "випадок", "случай", "можливість", "возможность", "здатність",
        "способность",
        "стан", "состояние", "статус", "статус", "зміна", "изменение", "процес", "процесс", "розвиток", "развитие",
        "підтримка", "поддержка", "допомога", "помощь", "ресурс", "ресурс", "потреба", "необходимость", "потребность",
        "влада", "власть", "уряд", "правительство", "організація", "организация", "служба",
        "захід", "мероприятие", "зустріч", "встреча", "переговори", "переговоры",
        "вогонь", "огонь", "вода", "вода", "земля", "земля", "повітря", "воздух",
        "життя", "жизнь", "смерть", "смерть", "здоров'я", "здоровье", "залишки", "ліс", "лес",

        # --- Generic Adjectives / Adverbs ---
        "новий", "новый", "старий", "старый", "великий", "большой", "малий", "малый", "маленький",
        "добрий", "добрый", "хороший", "гарний", "красивый", "поганий", "плохой",
        "можливий", "возможный", "ймовірний", "вероятный", "очевидний", "очевидный",
        "різний", "разный", "інший", "другой", "иной", "однаковий", "одинаковый", "схожий", "похожий",
        "загальний", "общий", "основний", "основной", "головний", "главный", "важливий", "важный",
        "певний", "определенный", "невизначений", "неопределенный", "відомий", "известный", "невідомий", "неизвестный",
        "військовий", "военный", "цивільний", "гражданский",
        "останній", "последний", "попередній", "предыдущий", "наступний", "следующий",
        "правий", "правый", "лівий", "левый", "верхній", "верхний", "нижній", "нижний",
        "східний", "восточный", "західний", "западный", "північний", "северный", "південний", "южный",
        "швидко", "быстро", "повільно", "медленно", "добре", "хорошо", "погано", "плохо",
        "сильно", "сильно", "слабко", "слабо", "більше", "больше", "менше", "меньше", "краще", "лучше", "гірше", "хуже",
        "разом", "вместе", "окремо", "отдельно", "приблизно", "приблизительно",
        "майже", "почти", "дуже", "очень", "надто", "слишком", "достатньо", "достаточно", "особливо", "особенно",
        "звичайно", "обычно",
        "переважно", "преимущественно", "насправді", "на самом деле", "дійсно", "действительно",
        "зокрема", "в частности", "наприклад", "например",

        # --- Numbers / Quantifiers ---
        "один", "одна", "одне",
        "два", "дві",
        "три",
        "чотири", "четыре",
        "п'ять", "пять", "шість", "шесть", "сім", "семь", "вісім", "восемь", "дев'ять", "девять", "десять",
        "нуль", "ноль", "декілька", "несколько", "багато", "много", "мало", "кілька", "несколько",
        "пара", "сотня", "тисяча", "тысяча", "мільйон", "миллион",
        "перший", "первый", "другий", "второй", "третій", "третий", "четвертий", "четвертый", "п'ятий", "пятый",
        "раз", "рази", "раза",

        # --- Other ---
        "берег", "катер", "острів", "остров", "імовірність", "вероятность", "з", "из", "слово", "Міноборони",
        "Минобороны", "вимикати", "выключать",
        "підрозділ", "подразделение", "скупчення", "скопление", "підписувати", "подписывать", "над", "на""повторний",
        "повторный", "прямий", "прямой",
        "місія", "миссия", "передавати", "передавать", "береговий", "береговой", "лінія", "линия", "мінімум", "минимум",
        "департамент", "захист", "защита",
        "війна", "война", "ЗСУ", "Генштаб", "журналіст", "журналист", "уточнення", "уточнение", "склад", "міністерство",
        "министерство", "оборона",
        "зв'язок", "связь", "окупант", "оккупант", "обіцяти", "обещать", "компанія", "компания", "загалом", "в общем",
        "в целом", "інфраструктура",
        "пожежа", "пожар", "внаслідок", "вследствие", "поранити", "ранить", "жінка", "женщина", "голова", "глава",
        "ОВА", "президент", "збирати", "собирать",
        "супутник", "спутник", "одиниця", "единица", "застосунок", "приложение", "опублікувати", "опубликовать",
        "супутниковий", "спутниковый", "знімок", "снимок",
        "водосховище", "водохранилище", "енергоблок", "черга", "очередь", "відповідь", "ответ", "ваш", "зупинитися",
        "остановиться", "житловий", "жилой",
        "відповідний", "соответствующий", "розділитися", "разделиться", "фонд", "відкрити", "открыть", "збір", "сбор",
        "повз", "мимо", "більшість", "большинство"
    }

    stop_words.update(custom_stops)

    def preprocess_text(text):
        text = ftfy.fix_text(text)

        #  common map links
        text = re.sub(r"https://hromadske.ua/posts*?\.", "", text, flags=re.IGNORECASE)
        # bracketed numbers
        text = re.sub(r'\[\d+\]', '', text)

        text = re.sub(
            r'((([A-Za-z]{3,9}:(?://)?)(?:[-;:&=\+\$,\w]+@)?[A-Za-z0-9.-]+|(?:www.|[-;:&=\+\$,\w]+@)[A-Za-z0-9.-]+)((?:/[\+~%/.\w_-]*)?\??(?:[-\+=&;%@.\w_]*)#?(?:[.\!/\\\w]*)))',
            '', text)

        text = text.lower()

        # punctuation
        text = re.sub(r'\d+', '', text)
        text = re.sub(r'[^\w\s-]', '', text)
        text = re.sub(r'\s-\s|\s-$|^-', ' ', text)

        # tokenization
        tokens = word_tokenize(text)

        # lemmatization
        processed_tokens = [
            lemmatizer.lemmatize(word) for word in tokens
            if word not in stop_words and len(word) > 2 and not word.startswith('-') and not word.endswith('-')
        ]

        return ' '.join(processed_tokens)

    df['processed_text'] = df['content'].apply(preprocess_text)
    df = df.drop(columns=['content'])

    script_dir = os.path.dirname(os.path.abspath(__file__))
    project_root = os.path.abspath(os.path.join(script_dir, '..', '..')) 
    artifacts_dir = os.path.join(project_root, 'artifacts') 

    vectorizer_path = os.path.join(artifacts_dir, 'tfidf_vectorizer_tg.pkl')
    svd_path = os.path.join(artifacts_dir, 'svd_reducer_tg.pkl')

    with open(vectorizer_path, 'rb') as f:
        tfidf_vectorizer_tg = pickle.load(f)

    with open(svd_path, 'rb') as f:
        svd_reducer_tg = pickle.load(f)

    tfidf_matrix_today_tg = tfidf_vectorizer_tg.transform(df['processed_text'])
    tfidf_svd_matrix_today_tg = svd_reducer_tg.transform(tfidf_matrix_today_tg)
    svd_feature_names = [f'svd2_comp_{i + 1}' for i in range(30)]
    df_tfidf_svd_tg = pd.DataFrame(tfidf_svd_matrix_today_tg, columns=svd_feature_names, index=df.index)

    df_tfidf_svd_tg['date'] = df['date']
    date_col = df_tfidf_svd_tg.pop('date')  # make the 'date' column appear first
    df_tfidf_svd_tg.insert(0, 'date', date_col)
    
    return df_tfidf_svd_tg
